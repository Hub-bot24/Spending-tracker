<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spending – Monthly Subtractor</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  }
</script>

<style>
  :root{--b:#111827;--g:#6b7280;--bg:#f9fafb;--brand:#111827;--ok:#16a34a;--warn:#ef4444}
  *{box-sizing:border-box}
  body{font-family:system-ui,apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
  .wrap{max-width:760px;margin:16px auto;padding:0 16px; padding-bottom:112px;} /* leave space for tabs & fab */
  .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);margin:12px 0}
  h1{font-size:clamp(20px,3.2vw,28px);margin:6px 0 4px;color:var(--b)}
  .muted{color:var(--g)}

  label{display:block;margin:.5rem 0 .25rem;color:var(--b);font-weight:600}
  input{width:100%;padding:.75rem;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
  .row{display:grid;grid-template-columns:1fr 140px 110px;gap:10px;align-items:end}
  .row .full{grid-column:1/-1}
  .btn{display:inline-block;background:var(--brand);color:#fff;border:none;border-radius:12px;padding:.65rem 1rem;font-weight:700;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--b);border:1px solid #e5e7eb}
  .table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  .table th:last-child,.table td:last-child{text-align:right}
  .pill{display:inline-block;font-weight:700}
  .pill.ok{color:var(--ok)}
  .pill.bad{color:var(--warn)}

  /* bottom tabs */
  .tabs{
    position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;
    display:flex;gap:8px;padding:10px 12px;z-index:9999;
  }
  .tabs a{
    flex:1;text-align:center;text-decoration:none;border:1px solid #eee;border-radius:12px;
    padding:12px 0;color:#111827;font-weight:700;-webkit-tap-highlight-color:transparent;
  }
  .tabs a.active{background:#111827;color:#fff;border-color:#111827}

  /* Floating Add button */
  .fab{
    position:fixed;right:16px;bottom:76px;z-index:10000;
    background:#111827;color:#fff;border:none;border-radius:28px;
    height:56px;min-width:56px;padding:0 18px;font-weight:800;font-size:16px;
    display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);cursor:pointer;
  }
  .fab span{font-size:22px;line-height:1}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Spending (Monthly)</h1>
      <p class="muted">Enter your monthly spending money, then add expenses below.</p>

      <label for="budget">Monthly spending money (AUD)</label>
      <input id="budget" inputmode="decimal" placeholder="e.g. 1200" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="setBudget()">Save budget</button>
        <button class="btn secondary" onclick="resetAll()">Reset month</button>
        <button class="btn secondary" onclick="copySummary()">Copy summary</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="desc">Entry</label>
          <input id="desc" placeholder="e.g. Groceries" />
        </div>
        <div>
          <label for="amount">Amount (AUD)</label>
          <input id="amount" inputmode="decimal" placeholder="e.g. 75.50 (use - for refund/credit)" />
        </div>
        <div class="full muted">Tip: you can enter negative numbers (e.g., <code>-20</code>) if you need to undo something.</div>
      </div>

      <table class="table" id="list">
        <thead><tr><th>Date</th><th>Entry</th><th>Amount</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div><div class="muted">Budget (month)</div><div id="tBudget">$0</div></div>
        <div><div class="muted">Spent</div><div id="tSpent">$0</div></div>
        <div><div class="muted">Remaining</div><div id="tRemain" class="pill">$0</div></div>
      </div>
    </div>
  </div>

  <button class="fab" onclick="addEntry()"><span>＋</span> Add</button>

  <nav class="tabs">
    <a class="active" href="./">Spending</a>
    <a href="food/">Food</a>
    <a href="savings/">Savings</a>
  </nav>

<script>
const KEY = 'spending-v2';

// >>> NEW: sync config <<<
const SYNC_URL = 'https://script.google.com/macros/s/AKfycby8Oxf0aeJivWrugm68628wyDb_ZTCLOJEXYK83RkusnZJiidixzqn9MQ1TwA9tNSSy/exec';
const LAST_SYNC_KEY = 'hb_last_sync_master';

let state = {
  budget: 0,
  items: [] // {id, date, desc, amount}
};

function fmt(n){ return (n<0?'-':'') + '$' + Math.abs(n).toFixed(2); }

function load(){
  try{ const s=JSON.parse(localStorage.getItem(KEY)); if(s) state=s; }catch(e){}
  render(); document.getElementById('budget').value = state.budget || '';
}

// >>> CHANGED: save now also pushes to the sheet <<<
function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
  syncPushState();
}

function setBudget(){
  state.budget = Number(document.getElementById('budget').value||0);
  save(); render();
}

function addEntry(){
  const desc = document.getElementById('desc').value.trim();
  const amount = Number(document.getElementById('amount').value||0);
  if(!desc){ alert('Please type an entry'); return; }
  if(!amount && amount!==0){ alert('Please enter an amount'); return; }
  state.items.unshift({ id: Date.now(), date: new Date().toISOString().slice(0,10), desc, amount });
  document.getElementById('desc').value='';
  document.getElementById('amount').value='';
  save(); render();
}

function del(id){
  if(!confirm('Delete this entry?')) return;
  state.items = state.items.filter(x=>x.id!==id);
  save(); render();
}

function resetAll(){
  if(!confirm('Reset this month? This clears entries and budget.')) return;
  state = {budget:0, items:[]};
  save(); render();
}

function copySummary(){
  const spent = state.items.reduce((s,i)=>s+Number(i.amount||0),0);
  const remain = Number(state.budget||0) - spent;
  const lines = [
    `Spending (Monthly)`,
    `Budget: ${fmt(state.budget||0)}`,
    `Spent: ${fmt(spent)}`,
    `Remaining: ${fmt(remain)}`,
    ``,
    `Entries:`,
    ...(state.items.map(i=>`${i.date}: ${i.desc} — ${fmt(i.amount)}`))
  ];
  navigator.clipboard.writeText(lines.join('\n')).then(()=>alert('Summary copied.'));
}

function render(){
  // table
  const tb = document.querySelector('#list tbody'); tb.innerHTML='';
  state.items.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i.date}</td><td>${i.desc}</td><td>${fmt(i.amount)}</td>
                    <td><button class="btn secondary" onclick="del(${i.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
  // totals
  const spent = state.items.reduce((s,i)=>s+Number(i.amount||0),0);
  const remain = Number(state.budget||0) - spent;
  document.getElementById('tBudget').textContent = fmt(Number(state.budget||0));
  document.getElementById('tSpent').textContent = fmt(spent);
  const r = document.getElementById('tRemain');
  r.textContent = fmt(remain);
  r.className = 'pill ' + (remain>=0?'ok':'bad');
}

// >>> NEW: push local state to Google Sheet <<<
function syncPushState(){
  if (!SYNC_URL) return;
  try {
    const stateCopy = JSON.parse(JSON.stringify(state));
    const updatedAt = Date.now();
    const row = {
      id: 'master',
      user: 'family',
      category: '',
      note: JSON.stringify(stateCopy),
      amount: 0,
      date: '',
      deleted: false,
      updatedAt: updatedAt
    };

    // Simple POST, no custom headers => no CORS preflight issues
    fetch(SYNC_URL, {
      method: 'POST',
      body: JSON.stringify({ rows: [row] })
    }).then(() => {
      localStorage.setItem(LAST_SYNC_KEY, String(updatedAt));
    }).catch(e => console.warn('Sync push failed', e));
  } catch (e) {
    console.warn('Sync push failed', e);
  }
}


// >>> NEW: pull latest state from Google Sheet <<<
function syncPullState(){
  if (!SYNC_URL) return;
  const since = Number(localStorage.getItem(LAST_SYNC_KEY) || 0);
  fetch(`${SYNC_URL}?since=${since}`)
    .then(res => res.json())
    .then(data => {
      if (!data.ok || !Array.isArray(data.rows) || data.rows.length === 0) return;
      let latest = data.rows[0];
      for (const r of data.rows){
        if (Number(r.updatedAt || 0) > Number(latest.updatedAt || 0)){
          latest = r;
        }
      }
      if (latest.note){
        try {
          const remoteState = JSON.parse(latest.note);
          if (remoteState && typeof remoteState === 'object'){
            state = remoteState;
            localStorage.setItem(KEY, JSON.stringify(state));
            localStorage.setItem(LAST_SYNC_KEY, String(latest.updatedAt || Date.now()));
            render();
            document.getElementById('budget').value = state.budget || '';
          }
        } catch (e) {
          console.warn('Failed to apply remote state', e);
        }
      }
    })
    .catch(e => console.warn('Sync pull failed', e));
}

// initial load + start polling for remote changes
load();
syncPullState();
setInterval(syncPullState, 30000);
</script>
</body>
</html>

